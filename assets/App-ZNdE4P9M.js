import{j as e,H as D,g as oe,u as ae,e as le,r as n,h as ne,B as E,i as ce,v as V,E as ie,k as re,l as de,m as ue,M as pe,C as he,P as xe,F as S,b as fe,n as be,o as Ce,p as ge,q as me,s as we,Q as Ee}from"./vendor-CnLy6pY0.js";import{M as Se}from"./components-rn_Tn36V.js";const je=({data:i,selected:r})=>{const{label:j,testCases:v,color:u}=i,C=v.length;return e.jsxs("div",{className:`text-xs outline rounded relative p-2 text-[#ECF0F1] max-w-[150px] text-center ${r?"outline-[#2980B9]":"outline-[#373737]"}`,children:[e.jsx("div",{children:j}),e.jsx(D,{type:"source",position:"right"}),e.jsx(D,{type:"target",position:"left"}),C>0&&e.jsx("div",{className:"absolute top-[-10px] right-[-10px] w-[20px] h-[20px] rounded-full bg-[#E0E0E0] text-slate-700 flex items-center justify-center text-xs",children:C})]})},ve=je,ke=({data:i})=>e.jsxs("div",{className:"text-[#ECF0F1] text-xs rounded-full w-[50px] h-[50px] flex justify-center items-center bg-[#34495E]",children:[e.jsx("div",{children:i.label}),e.jsx(D,{type:"source",position:"right"}),e.jsx(D,{type:"target",position:"left"})]}),ye=ke,Ne=({id:i,sourceX:r,sourceY:j,targetX:v,targetY:u,sourcePosition:C,targetPosition:P,markerEnd:k,data:a})=>{const[y,p,B]=oe({sourceX:r,sourceY:j,targetX:v,targetY:u,sourcePosition:C,targetPosition:P});return e.jsxs(e.Fragment,{children:[e.jsx("path",{id:i,className:"stroke-[#BDC3C7] stroke-[2] fill-none",d:y,markerEnd:k}),(a==null?void 0:a.label)&&e.jsx("text",{x:p,y:B,style:{fontSize:12},textAnchor:"middle",children:a.label})]})},Fe=Ne;function De(){var M,O,I;const[i,r,j]=ae([]),[v,u,C]=le([]),[P,k]=n.useState(!1),[a,y]=n.useState(null),[p,B]=n.useState(null),{setViewport:L}=ne(),W={customNode:ve,connector:ye},q={customEdge:Fe},b={toastDelete:n.useCallback(()=>{E.error("No node selected to delete.",{autoClose:1e3})},[]),toastDeleteSuccess:n.useCallback(()=>{E.success("Node Deleted.",{autoClose:1e3})},[]),toastSaveError:n.useCallback(()=>{E.error("Server Save Failed: Unable to save changes.",{autoClose:1e3})},[]),toastSaveSuccess:n.useCallback(()=>{E.success("Changes saved successfully!",{autoClose:1e3})},[]),toastSaveErrorLocal:n.useCallback(()=>{E.error("Local Save Failed: Unable to save changes locally.",{autoClose:1e3})},[]),toastSaveLocalSuccess:n.useCallback(()=>{E.success("Changes saved locally!",{autoClose:1e3})},[])},[g,T]=n.useState({total:0,notstarted:0,passed:0,failed:0,blocked:0,notapplicable:0}),[H,J]=n.useState(!1),N=n.useRef(null),U=n.useCallback(()=>{J(s=>!s)},[]);n.useEffect(()=>{(async()=>{try{const t=await fetch("https://code-me-n0t.github.io/TestFlowManager/flow.json");if(t.ok){const l=await t.json(),{x:o=0,y:h=0,zoom:F=1}=l.viewport||{},d=(l.nodes||[]).map(c=>{var f,m,A;return{...c,position:{x:typeof((f=c.position)==null?void 0:f.x)=="number"?c.position.x:0,y:typeof((m=c.position)==null?void 0:m.y)=="number"?c.position.y:0},style:{backgroundColor:((A=c.style)==null?void 0:A.backgroundColor)||"inherit"}}}),x=(l.edges||[]).map(c=>({...c}));r(d),u(x),L({x:o,y:h,zoom:F}),l.nodes&&T($(l.nodes)),p&&p.fitView()}else console.warn("Failed to load flow data: Check the flow.json")}catch(t){console.error("Failed to load flow data:",t)}})()},[r,u,L,T,p]);const Q=n.useCallback(s=>u(t=>ce({...s,animated:!0,type:"customEdge"},t)),[u]),X=n.useCallback(()=>{const s=i[i.length-1],t=s?s.position:{x:0,y:0},l={id:V(),position:{x:t.x+100,y:t.y+100},data:{label:`Test Scenario ${i.length+1}`,testCases:[]},sourcePosition:"right",targetPosition:"left",type:"customNode"};r(o=>[...o,l])},[i,r]),Y=n.useCallback(()=>{const s=i[i.length-1],t=s?s.position:{x:0,y:0},l={id:V(),position:{x:t.x+100,y:t.y+100},type:"connector",data:{label:`${i.length+1}`},sourcePosition:"right",targetPosition:"left"};r(o=>[...o,l])},[i,r]),Z=n.useCallback((s,t)=>{N.current?(clearTimeout(N.current),N.current=null,k(!0)):N.current=setTimeout(()=>{N.current=null},200),r(l=>l.map(o=>o.id===t.id?{...o,selected:!0}:{...o,selected:!1})),y(t)},[r]),G=n.useCallback(()=>{k(!1),y(null)},[]),K=n.useCallback((s,t,l)=>{r(o=>{const h=o.map(d=>d.id===a.id?{...d,data:{...d.data,label:t,testCases:s},style:{...d.style,backgroundColor:l||"#1C1C1E"},type:"customNode"}:d),F=$(h);return T(F),h})},[a,r,T]),ee=n.useCallback(async s=>{console.time("Export to Excel");const t=new ie.Workbook,l=new Set,o=d=>{const x=d.replace(/[^a-zA-Z0-9_]/g,"_").slice(0,31);let c=x,f=1;for(;l.has(c);)c=`${x}_${f}`,f++,c.length>31&&(c=c.slice(0,31));return l.add(c),c};for(const d of s)if(d.data.testCases&&d.data.testCases.length>0){const x=d.data.label||`Sheet${s.indexOf(d)+1}`,c=o(x),f=d.data.testCases||[];console.log(`Processing node: ${x}`),console.log("Test Cases:",f);const m=t.addWorksheet(c);m.addRow(["Test ID","Test Case","Status"]),f.forEach((w,z)=>{m.addRow([z+1,w.content,w.status,w.description||""])}),(()=>{m.columns.forEach(w=>{let z=0;w.eachCell({includeEmpty:!0},R=>{const _=R.value?R.value.toString().length:0;_>z&&(z=_)}),w.width=z})})(),console.timeEnd(`Creating sheet for ${c}`)}console.timeEnd("Export to Excel");const h=await t.xlsx.writeBuffer(),F=new Blob([h],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});re.saveAs(F,"test_cases.xlsx"),console.log("File saved!")},[]),$=n.useCallback(s=>{const t={total:0,notstarted:0,passed:0,failed:0,blocked:0,notapplicable:0};return s.forEach(l=>{l.data&&l.data.testCases&&(t.total+=l.data.testCases.length,l.data.testCases.forEach(o=>{o.status==="notstarted"?t.notstarted+=1:o.status==="passed"?t.passed+=1:o.status==="failed"?t.failed+=1:o.status==="blocked"?t.blocked+=1:o.status==="notapplicable"&&(t.notapplicable+=1)}))}),t},[]),te=n.useCallback(()=>{a?(r(s=>s.filter(t=>t.id!==a.id)),u(s=>s.filter(t=>t.source!==a.id&&t.target!==a.id)),b.toastDeleteSuccess(),k(!1),y(null)):b.toastDelete()},[a,r,u,b]),se=n.useCallback(()=>{if(p){const s=p.toObject(),t=$(s.nodes),l=JSON.stringify({...s,testCaseStats:t},null,4);fetch("http://localhost:3000/flow",{method:"POST",headers:{"Content-Type":"application/json"},body:l}).then(o=>o.json()).then(o=>{o&&b.toastSaveSuccess()}).catch(o=>{console.error("Failed to save flow data to server:",o);try{localStorage.setItem("flowData",l),b.toastSaveLocalSuccess()}catch(h){console.error("Failed to save flow data to localStorage:",h),b.toastSaveErrorLocal()}})}else b.toastSaveError()},[p]);return e.jsxs("div",{style:{height:"100vh",width:"100%"},children:[e.jsxs(de,{colorMode:"dark",nodes:i,nodeTypes:W,onNodesChange:j,edges:v,edgeTypes:q,onEdgesChange:C,onConnect:Q,onInit:B,fitView:!0,zoomOnScroll:!1,zoomOnDoubleClick:!1,onNodeClick:Z,children:[e.jsx(ue,{}),e.jsx(pe,{}),e.jsx(he,{}),e.jsxs(xe,{position:"top-left panel",className:"flex flex-col space-y-4",children:[e.jsxs("div",{className:"button-container flex space-x-2",children:[e.jsx("button",{className:"delete p-2 rounded bg-[#3E3E3E] hover:bg-red-600 size-12",onClick:te,children:e.jsx(S,{icon:fe,size:"lg",color:"white"})}),e.jsx("button",{className:"download rounded rounded bg-[#3E3E3E] hover:bg-[#2980B9] size-12",onClick:()=>ee(i),children:e.jsx(S,{icon:be,size:"lg",color:"white"})}),e.jsx("button",{className:"add p-2 rounded bg-[#3E3E3E] hover:bg-[#2980B9] size-12",onClick:X,children:e.jsx(S,{icon:Ce,size:"lg",color:"white"})}),e.jsx("button",{className:"connector p-2 rounded bg-[#3E3E3E] hover:bg-[#2980B9] size-12",onClick:Y,children:e.jsx(S,{icon:ge,size:"lg",color:"white"})}),e.jsx("button",{className:"save p-2 rounded bg-[#3E3E3E] hover:bg-[#2980B9] size-12",onClick:se,children:e.jsx(S,{icon:me,size:"lg",color:"white"})})]}),e.jsxs("div",{className:"relative",children:[e.jsxs("div",{className:"flex justify-between items-center text-sm p-2 bg-[#2d2d2d] opacity-70 rounded text-white",children:[e.jsxs("p",{children:["Total Test Count: ",g.total]}),e.jsx("button",{className:"dropdown-button p-2 rounded bg-[#3E3E3E] hover:bg-[#2980B9] flex items-center",onClick:U,children:e.jsx(S,{icon:we,size:"lg",color:"white"})})]}),H&&e.jsxs("div",{className:"dropdown-menu mt-2 bg-[#2d2d2d] p-2 opacity-70 rounded text-white",children:[e.jsxs("p",{children:["Not Started: ",g.notstarted]}),e.jsxs("p",{children:["Passed: ",g.passed]}),e.jsxs("p",{children:["Failed: ",g.failed]}),e.jsxs("p",{children:["Blocked: ",g.blocked]}),e.jsxs("p",{children:["Not Applicable: ",g.notapplicable]})]})]})]})]}),e.jsx(Ee,{}),e.jsx(Se,{isOpen:P,onClose:G,nodeId:a==null?void 0:a.id,nodeLabel:((M=a==null?void 0:a.data)==null?void 0:M.label)||"",testCases:((O=a==null?void 0:a.data)==null?void 0:O.testCases)||[],onSave:K,borderColor:((I=a==null?void 0:a.data)==null?void 0:I.color)||"#1C1C1E"})]})}export{De as default};
