import{j as e,H as P,h as re,u as ie,i as de,r as l,k as ue,B as w,l as he,v as J,E as pe,m as xe,n as fe,o as ge,M as Ce,C as be,P as me,F as m,b as ve,p as Se,q as ye,s as Ee,t as we,w as je,x as ke,Q as Ne}from"./vendor-C0PXxGFu.js";import{V as Fe,M as ze}from"./components-D9DC3Dt5.js";const Te=({data:u,selected:i})=>{const{label:j,testCases:k}=u,p=k.length;return e.jsxs("div",{className:`text-xs outline rounded relative p-2 text-[#ECF0F1] bg-[#1c1c1e] max-w-[150px] text-center ${i?"outline-[#2980B9]":"outline-[#373737]"}`,children:[e.jsx("div",{children:j}),e.jsx(P,{type:"source",position:"right",className:"handle-style"}),e.jsx(P,{type:"target",position:"left",className:"handle-style"}),p>0&&e.jsx("div",{className:"absolute top-[-10px] right-[-10px] w-[1.5rem] h-[1.5rem] rounded-full bg-[#E0E0E0] text-slate-700 flex items-center justify-center text-xs",children:p})]})},Oe=Te,Pe=({data:u})=>e.jsxs("div",{className:"text-[#ECF0F1] text-xs rounded-full w-[50px] h-[50px] flex justify-center items-center bg-[#34495E]",children:[e.jsx("div",{children:u.label}),e.jsx(P,{type:"source",position:"right",className:"handle-style"}),e.jsx(P,{type:"target",position:"left",className:"handle-style"})]}),De=Pe,Ve=({id:u,sourceX:i,sourceY:j,targetX:k,targetY:p,sourcePosition:D,targetPosition:V,markerEnd:N,data:a})=>{const[b,g,B]=re({sourceX:i,sourceY:j,targetX:k,targetY:p,sourcePosition:D,targetPosition:V});return e.jsxs(e.Fragment,{children:[e.jsx("path",{id:u,className:"stroke-[#BDC3C7] stroke-[2] fill-none",d:b,markerEnd:N}),(a==null?void 0:a.label)&&e.jsx("text",{x:g,y:B,style:{fontSize:12},textAnchor:"middle",children:a.label})]})},Be=Ve;function Ae(){var I,L,H;const[u,i,j]=ie([]),[k,p,D]=de([]),[V,N]=l.useState(!1),[a,b]=l.useState(null),[g,B]=l.useState(null),{setViewport:O}=ue(),[W,A]=l.useState(!1),q=l.useCallback(()=>A(!0),[]),$=l.useCallback(()=>A(!1),[]),U={customNode:Oe,connector:De},Q={customEdge:Be},x={toastDelete:l.useCallback(()=>{w.error("No node selected to delete.",{autoClose:1e3})},[]),toastDeleteSuccess:l.useCallback(()=>{w.success("Node Deleted.",{autoClose:1e3})},[]),toastSaveError:l.useCallback(()=>{w.error("Server Save Failed: Unable to save changes.",{autoClose:1e3})},[]),toastSaveSuccess:l.useCallback(()=>{w.success("Changes saved successfully!",{autoClose:1e3})},[]),toastSaveErrorLocal:l.useCallback(()=>{w.error("Local Save Failed: Unable to save changes locally.",{autoClose:1e3})},[]),toastSaveLocalSuccess:l.useCallback(()=>{w.success("Changes saved locally!",{autoClose:1e3})},[])},[v,F]=l.useState({total:0,notstarted:0,passed:0,failed:0,blocked:0,notapplicable:0}),[X,Y]=l.useState(!1),z=l.useRef(null),Z=l.useCallback(()=>{Y(o=>!o)},[]);l.useEffect(()=>{(async()=>{try{const t=await fetch("https://code-me-n0t.github.io/TestFlowManager/flow.json");if(t.ok){const s=await t.json(),{x:n=0,y:h=0,zoom:f=1}=s.viewport||{},r=(s.nodes||[]).map(c=>{var C,y,M;return{...c,position:{x:typeof((C=c.position)==null?void 0:C.x)=="number"?c.position.x:0,y:typeof((y=c.position)==null?void 0:y.y)=="number"?c.position.y:0},style:{backgroundColor:((M=c.style)==null?void 0:M.backgroundColor)||"inherit"}}}),d=(s.edges||[]).map(c=>({...c}));i(r),p(d),O({x:n,y:h,zoom:f}),s.nodes&&F(S(s.nodes)),g&&g.fitView()}else console.warn("Failed to load flow data: Check the flow.json")}catch(t){console.error("Failed to load flow data:",t)}})()},[i,p,O,F,g]);const G=l.useCallback(o=>p(t=>he({...o,animated:!0,type:"customEdge"},t)),[p]),K=l.useCallback(()=>{const o=u[u.length-1],t=o?o.position:{x:0,y:0},s={id:J(),position:{x:t.x+100,y:t.y+100},data:{label:`Test Scenario ${u.length+1}`,testCases:[]},sourcePosition:"right",targetPosition:"left",type:"customNode"};i(n=>[...n,s])},[u,i]),ee=l.useCallback(()=>{const o=u[u.length-1],t=o?o.position:{x:0,y:0},s={id:J(),position:{x:t.x+100,y:t.y+100},type:"connector",data:{label:`${u.length+1}`},sourcePosition:"right",targetPosition:"left"};i(n=>[...n,s])},[u,i]),te=l.useCallback((o,t)=>{z.current?(clearTimeout(z.current),z.current=null,N(!0)):z.current=setTimeout(()=>{z.current=null},200),i(s=>s.map(n=>n.id===t.id?{...n,selected:!0}:{...n,selected:!1})),b(t)},[i]),se=l.useCallback(()=>{N(!1),b(null)},[]),oe=l.useCallback((o,t,s)=>{i(n=>{const h=n.map(r=>r.id===a.id?{...r,data:{...r.data,label:t,testCases:o},style:{...r.style,backgroundColor:s||"#1C1C1E"},type:"customNode"}:r),f=S(h);return F(f),h})},[a,i,F]),ae=l.useCallback(async o=>{console.time("Export to Excel");const t=new pe.Workbook,s=new Set,n=r=>{const d=r.replace(/[^a-zA-Z0-9_]/g,"_").slice(0,31);let c=d,C=1;for(;s.has(c);)c=`${d}_${C}`,C++,c.length>31&&(c=c.slice(0,31));return s.add(c),c};for(const r of o)if(r.data.testCases&&r.data.testCases.length>0){const d=r.data.label||`Sheet${o.indexOf(r)+1}`,c=n(d),C=r.data.testCases||[];console.log(`Processing node: ${d}`),console.log("Test Cases:",C);const y=t.addWorksheet(c);y.addRow(["Test ID","Test Case","Status"]),C.forEach((E,T)=>{y.addRow([T+1,E.content,E.status,E.description||""])}),(()=>{y.columns.forEach(E=>{let T=0;E.eachCell({includeEmpty:!0},R=>{const _=R.value?R.value.toString().length:0;_>T&&(T=_)}),E.width=T})})(),console.timeEnd(`Creating sheet for ${c}`)}console.timeEnd("Export to Excel");const h=await t.xlsx.writeBuffer(),f=new Blob([h],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});xe.saveAs(f,"test_cases.xlsx"),console.log("File saved!")},[]),S=l.useCallback(o=>{const t={total:0,notstarted:0,passed:0,failed:0,blocked:0,notapplicable:0};return o.forEach(s=>{s.data&&s.data.testCases&&s.data.testCases.forEach(n=>{t[n.status]!==void 0&&(t[n.status]+=1)})}),t.total=Object.values(t).reduce((s,n)=>s+n,0),t},[]),le=l.useCallback(o=>{try{const t=typeof o=="string"?JSON.parse(o):o,s=t.nodes||[],n=t.edges||[],h=t.viewport||{x:0,y:0,zoom:1};console.log(testcase),i(s),p(n),O(h);const f=a==null?void 0:a.id;if(f){const d=s.find(c=>c.id===f);b(d||null)}else b(null);const r=S(s);F(r),$()}catch(t){console.error("Error selecting version:",t)}},[a,i,p,O,S,$]),ne=l.useCallback(()=>{a?(i(o=>o.filter(t=>t.id!==a.id)),p(o=>o.filter(t=>t.source!==a.id&&t.target!==a.id)),x.toastDeleteSuccess(),N(!1),b(null)):x.toastDelete()},[a,i,p,x]),ce=l.useCallback(()=>{if(g){const o=g.toObject(),t=S(o.nodes),s=JSON.stringify({...o,testCaseStats:t},null,4),n=h=>{const r={timestamp:new Date().toISOString(),flowData:h};fetch("http://localhost:3000/flow/saveVersion",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)}).then(d=>d.json()).then(d=>{d?console.log("Version saved to server:",d.message):x.toastSaveError()}).catch(d=>{console.error("Failed to save version to server:",d),x.toastSaveError()})};fetch("http://localhost:3000/flow",{method:"POST",headers:{"Content-Type":"application/json"},body:s}).then(h=>h.json()).then(h=>{h?(x.toastSaveSuccess(),n(s)):x.toastSaveError()}).catch(h=>{console.error("Failed to save flow data to server:",h),x.toastSaveError();try{localStorage.setItem("flowData",s),x.toastSaveLocalSuccess()}catch(f){console.error("Failed to save flow data to localStorage:",f),x.toastSaveErrorLocal()}})}else x.toastSaveError()},[g,S]);return e.jsxs("div",{style:{height:"100vh",width:"100%"},children:[e.jsxs(fe,{colorMode:"dark",nodes:u,nodeTypes:U,onNodesChange:j,edges:k,edgeTypes:Q,onEdgesChange:D,onConnect:G,onInit:B,fitView:!0,zoomOnScroll:!1,zoomOnDoubleClick:!1,onNodeClick:te,children:[e.jsx(ge,{}),e.jsx(Ce,{}),e.jsx(be,{}),e.jsxs(me,{position:"top-left panel",className:"flex flex-col space-y-4",children:[e.jsxs("div",{className:"button-container flex space-x-2",children:[e.jsx("button",{className:"delete p-2 rounded bg-[#3E3E3E] hover:bg-red-600 size-12",onClick:ne,children:e.jsx(m,{icon:ve,size:"lg",color:"white"})}),e.jsx("button",{className:"version-history-btn p-2 rounded bg-[#3E3E3E] hover:bg-[#2980B9] size-12",onClick:q,children:e.jsx(m,{icon:Se,size:"lg",color:"white"})}),e.jsx("button",{className:"download rounded rounded bg-[#3E3E3E] hover:bg-[#2980B9] size-12",onClick:()=>ae(u),children:e.jsx(m,{icon:ye,size:"lg",color:"white"})}),e.jsx("button",{className:"add p-2 rounded bg-[#3E3E3E] hover:bg-[#2980B9] size-12",onClick:K,children:e.jsx(m,{icon:Ee,size:"lg",color:"white"})}),e.jsx("button",{className:"connector p-2 rounded bg-[#3E3E3E] hover:bg-[#2980B9] size-12",onClick:ee,children:e.jsx(m,{icon:we,size:"lg",color:"white"})}),e.jsx("button",{className:"save p-2 rounded bg-[#3E3E3E] hover:bg-[#2980B9] size-12",onClick:ce,children:e.jsx(m,{icon:je,size:"lg",color:"white"})})]}),e.jsxs("div",{className:"relative",children:[e.jsxs("div",{className:"flex justify-between items-center text-sm p-2 bg-[#2d2d2d] opacity-70 rounded text-white",children:[e.jsxs("p",{children:["Total Test Count: ",v.total]}),e.jsx("button",{className:"dropdown-button p-2 rounded bg-[#3E3E3E] hover:bg-[#2980B9] flex items-center",onClick:Z,children:e.jsx(m,{icon:ke,size:"lg",color:"white"})})]}),X&&e.jsxs("div",{className:"dropdown-menu mt-2 bg-[#2d2d2d] p-2 opacity-70 rounded text-white",children:[e.jsxs("p",{children:["Not Started: ",v.notstarted]}),e.jsxs("p",{children:["Passed: ",v.passed]}),e.jsxs("p",{children:["Failed: ",v.failed]}),e.jsxs("p",{children:["Blocked: ",v.blocked]}),e.jsxs("p",{children:["Not Applicable: ",v.notapplicable]})]})]})]})]}),e.jsx(Ne,{}),e.jsx(Fe,{isOpen:W,onClose:$,onSelectVersion:le}),e.jsx(ze,{isOpen:V,onClose:se,nodeId:a==null?void 0:a.id,nodeLabel:((I=a==null?void 0:a.data)==null?void 0:I.label)||"",testCases:((L=a==null?void 0:a.data)==null?void 0:L.testCases)||[],onSave:oe,borderColor:((H=a==null?void 0:a.data)==null?void 0:H.color)||"#1C1C1E"})]})}export{Ae as default};
